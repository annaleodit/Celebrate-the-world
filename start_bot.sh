#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å

BOT_DIR="/Users/annaleodit/Documents/Code/Culture Card Bot"
PID_FILE="$BOT_DIR/bot.pid"
LOG_FILE="$BOT_DIR/bot.log"
PYTHON_CMD="python3"

cd "$BOT_DIR" || exit 1

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
is_running() {
    local pid=$1
    if ps -p "$pid" > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python
if ! command -v "$PYTHON_CMD" &> /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: $PYTHON_CMD –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ bot.py
if [ ! -f "bot.py" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: bot.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞..."

# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ PID —Ñ–∞–π–ª–∞
if [ -f "$PID_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if is_running "$OLD_PID"; then
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—à –±–æ—Ç
        if ps -p "$OLD_PID" -o command= | grep -q "bot.py"; then
            echo "‚ö†Ô∏è  –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: $OLD_PID)"
            echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./stop_bot.sh"
            exit 1
        else
            echo "‚ö†Ô∏è  PID —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–π PID, —É–¥–∞–ª—è—é..."
            rm -f "$PID_FILE"
        fi
    else
        echo "üóëÔ∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID —Ñ–∞–π–ª (–ø—Ä–æ—Ü–µ—Å—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç), —É–¥–∞–ª—è—é..."
        rm -f "$PID_FILE"
    fi
fi

# –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–≥–∏—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
EXISTING_PROCESSES=$(ps aux | grep -i "python.*bot.py" | grep -v grep | awk '{print $2}')
if [ -n "$EXISTING_PROCESSES" ]; then
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞: $EXISTING_PROCESSES"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ ./stop_bot.sh –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∑–∞—Ç–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
    exit 1
fi

# –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞..."

# –°–æ–∑–¥–∞–µ–º PID —Ñ–∞–π–ª –∑–∞—Ä–∞–Ω–µ–µ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
echo "$$" > "$PID_FILE"

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
nohup "$PYTHON_CMD" bot.py > "$LOG_FILE" 2>&1 &
NEW_PID=$!

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞
echo "$NEW_PID" > "$PID_FILE"

# –î–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—É –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏ –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
if is_running "$NEW_PID"; then
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—à –±–æ—Ç
    if ps -p "$NEW_PID" -o command= | grep -q "bot.py"; then
        echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω (PID: $NEW_PID)"
        echo "üìã –õ–æ–≥–∏: tail -f $LOG_FILE"
        echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ./stop_bot.sh"
        exit 0
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –±–æ—Ç–æ–º"
        kill "$NEW_PID" 2>/dev/null
        rm -f "$PID_FILE"
        exit 1
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞: –±–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -n 50 $LOG_FILE"
    rm -f "$PID_FILE"
    exit 1
fi


